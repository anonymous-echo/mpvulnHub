# 此工作流会在update_daily.yml执行成功后触发，用于将daily.html部署到GitHub Pages

name: Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ["Update_daily"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    # 仅当触发的工作流成功时才运行
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Configure GitHub Pages
      uses: actions/configure-pages@v4

    - name: Prepare Pages content
      run: |
        # 显示当前工作目录和文件结构，用于调试
        echo "当前工作目录: $(pwd)"
        echo "列出根目录文件:"
        ls -la
        echo "列出daily目录文件:"
        ls -la daily || echo "daily目录不存在"
        
        # 检查daily.html文件是否存在
        if [ -f "daily/daily.html" ]; then
          echo "找到daily/daily.html文件"
          # 创建一个临时目录用于Pages部署
          mkdir -p gh-pages
          # 复制daily.html到临时目录并重命名为index.html
          cp daily/daily.html gh-pages/index.html
          # 创建404.html
          echo "404 - Page not found" > gh-pages/404.html
        else
          echo "错误: 找不到daily/daily.html文件"
          exit 1
        fi

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./gh-pages

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Commit and push if changed
      run: |
        # 配置Git
        git config --global user.email "791751568@qq.com"
        git config --global user.name "大清第一巴图鲁"
        
        # 显示当前分支和远程状态
        git branch -a
        git remote -v
        
        # 确保获取所有远程分支信息
        git fetch --all
        
        # 先保存main分支下的daily目录内容到临时位置
        echo "备份main分支下的daily目录..."
        mkdir -p temp_daily
        cp -r daily/* temp_daily/
        
        # 检查是否存在gh-pages分支
        if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
          echo "gh-pages分支已存在，尝试更新..."
          # 拉取现有gh-pages分支
          git fetch origin gh-pages
          
          # 检查本地是否已存在gh-pages分支
          if git show-ref --verify --quiet refs/heads/gh-pages; then
            echo "本地gh-pages分支已存在，切换到该分支..."
            git checkout gh-pages
            # 从远程分支拉取最新更改
            git pull origin gh-pages
          else
            echo "本地gh-pages分支不存在，创建并切换..."
            # 创建并切换到gh-pages分支
            git checkout -b gh-pages origin/gh-pages
          fi
        else
          echo "创建新的gh-pages分支..."
          # 确保本地没有gh-pages分支
          if git show-ref --verify --quiet refs/heads/gh-pages; then
            echo "删除本地gh-pages分支..."
            git branch -D gh-pages
          fi
          # 创建并切换到新的gh-pages分支
          git checkout --orphan gh-pages
          # 删除所有文件，准备初始提交
          git rm -rf .
        fi
        
        # 从临时位置恢复daily目录内容
        echo "恢复daily目录内容..."
        mkdir -p daily
        cp -r temp_daily/* daily/
        rm -rf temp_daily
        
        # 检查daily.html文件是否存在
        if [ ! -f "daily/daily.html" ]; then
          echo "错误: 找不到daily/daily.html文件"
          exit 1
        fi
        
        # 复制daily.html到当前目录并重命名为index.html
        cp daily/daily.html index.html
          # 创建新的gh-pages分支
          git checkout --orphan gh-pages
          # 删除所有文件，只保留必要的
          git rm -rf .
          # 复制daily.html到当前目录并重命名为index.html
          cp daily/daily.html index.html
          touch .gitkeep
          git add index.html .gitkeep
          git commit -m "Initial gh-pages commit with daily content"
          # 推送新分支到远程
          git push -u origin gh-pages
        fi
        
        # 检查daily.html文件是否存在
        if [ -f "daily/daily.html" ]; then
          echo "找到daily/daily.html文件"
          # 复制daily.html到根目录作为index.html
          cp daily/daily.html index.html
        else
          echo "错误: 找不到daily/daily.html文件"
          exit 1
        fi
        
        # 提交更改
        git add index.html
        if git diff-index --quiet HEAD; then
          echo "没有检测到更改，跳过提交..."
        else
          git commit -m "Update GitHub Pages with latest daily report"
          # 推送更改到gh-pages分支
          git push origin gh-pages
        fi

    - name: Show deployment URL
      run: |
        echo "部署成功！访问地址: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
